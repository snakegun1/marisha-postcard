<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Мариша — открытка</title>
  <style>
    :root{--bg:#000;--txt:#fff;--shadow:rgba(0,0,0,.45)}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#000;overscroll-behavior:none}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}

    .stage{position:fixed;inset:0;overflow:hidden;background:#000}
    .photo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.05)}

    /* Rainbow trail */
    .rainbow{position:absolute;height:38px;left:0;opacity:0; /* shown when cat visible */}
    .rainbow > div{position:absolute;top:0;bottom:0}
    .r-red{left:0;right:83.33%;background:#ff0018}
    .r-orange{left:16.66%;right:66.66%;background:#ffa52c}
    .r-yellow{left:33.33%;right:50%;background:#ffff41}
    .r-green{left:50%;right:33.33%;background:#008018}
    .r-blue{left:66.66%;right:16.66%;background:#0000f9}
    .r-violet{left:83.33%;right:0;background:#86007d}

    /* Pixel cat (tiny CSS-pixel art built from box-shadows) */
    .cat{position:absolute;width:1px;height:1px;opacity:0;image-rendering:pixelated}
    /* Build cat using CSS box-shadows (simple 12x10 sprite). Each 1px square scaled via transform */
    .cat::before{content:"";position:absolute;width:1px;height:1px;box-shadow:
      /* head */
      6px 2px #333,7px 2px #333,8px 2px #333,
      5px 3px #333,6px 3px #ccc,7px 3px #f5e6c8,8px 3px #ccc,9px 3px #333,
      5px 4px #333,6px 4px #f5e6c8,7px 4px #f5e6c8,8px 4px #f5e6c8,9px 4px #333,
      5px 5px #333,6px 5px #f5e6c8,7px 5px #000,8px 5px #f5e6c8,9px 5px #333,
      6px 6px #333,7px 6px #333,8px 6px #333,
      /* body */
      3px 5px #ff7aa2,4px 5px #ffb3c9,5px 5px #ff7aa2,
      2px 6px #ff7aa2,3px 6px #ffb3c9,4px 6px #ffb3c9,5px 6px #ffb3c9,6px 6px #ff7aa2,
      2px 7px #ff7aa2,3px 7px #ffb3c9,4px 7px #ffb3c9,5px 7px #ffb3c9,6px 7px #ff7aa2,
      3px 8px #ff7aa2,4px 8px #ffb3c9,5px 8px #ff7aa2,
      /* legs */
      4px 9px #333,6px 9px #333,8px 9px #333;
      transform:scale(6);transform-origin:0 0
    }

    /* Heart (SVG-sized container) */
    .heart{position:absolute;width:24px;height:24px;opacity:0}
    .caption{position:absolute;left:50%;transform:translateX(-50%);bottom:8vh;color:var(--txt);font-size:40px;letter-spacing:.5px;text-align:center;opacity:0;text-shadow:2px 2px 0 var(--shadow)}

    @media (max-width:380px){.caption{font-size:28px}}
    .ui{position:fixed;left:0;right:0;top:0;display:flex;gap:.5rem;justify-content:center;padding:.5rem;z-index:5}
    .btn{appearance:none;border:0;border-radius:12px;padding:.6rem .9rem;background:rgba(0,0,0,.55);color:#fff;font-size:14px;backdrop-filter:saturate(1.2) blur(4px)}
    .btn:active{transform:scale(.98)}
    .hint{position:fixed;left:50%;transform:translateX(-50%);bottom:2vh;color:#fff;font-size:12px;opacity:.7}
  </style>
</head>
<body>
  <div class="stage">
    <img class="photo" id="photo" alt="photo"/>
    <div class="rainbow" id="rainbow" aria-hidden="true">
      <div class="r-red"></div><div class="r-orange"></div><div class="r-yellow"></div>
      <div class="r-green"></div><div class="r-blue"></div><div class="r-violet"></div>
    </div>
    <div class="cat" id="cat" aria-hidden="true"></div>
    <svg class="heart" id="heart" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 21s-6.4-3.9-9.2-8C1 10 2.2 6.8 5 6.2 7 5.8 8.7 7 9.5 8.2c.8-1.2 2.5-2.4 4.5-2 2.8.6 4 3.8 2.2 6.8C18.4 17.1 12 21 12 21z" fill="#ff2b6a"/>
    </svg>
    <div class="caption" id="caption">Мариша самая красивая</div>
  </div>

  <div class="ui">
    <button class="btn" id="pick">Выбрать фото</button>
    <button class="btn" id="replay">Повторить</button>
    <input type="file" id="file" accept="image/*" hidden>
  </div>
  <div class="hint">Можно передать фото через параметр ?photo=URL</div>

  <script>
    (function(){
      const stage = document.querySelector('.stage');
      const photo = document.getElementById('photo');
      const cat = document.getElementById('cat');
      const rainbow = document.getElementById('rainbow');
      const heart = document.getElementById('heart');
      const caption = document.getElementById('caption');
      const input = document.getElementById('file');
      const pickBtn = document.getElementById('pick');
      const replayBtn = document.getElementById('replay');

      // Load photo from ?photo=...
      try {
        const params = new URLSearchParams(location.search);
        const p = params.get('photo');
        if(p){
          photo.src = p;
        } else {
          // tiny gradient placeholder
          const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='2000'><defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'><stop offset='0' stop-color='#111'/><stop offset='1' stop-color='#333'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/></svg>`);
          photo.src = 'data:image/svg+xml;utf8,'+svg;
        }
      } catch(e){}

      pickBtn.addEventListener('click', ()=> input.click());
      input.addEventListener('change', e => {
        const f = e.target.files && e.target.files[0];
        if(f){
          const url = URL.createObjectURL(f);
          photo.src = url;
          start();
        }
      });
      replayBtn.addEventListener('click', start);

      function start(){
        // reset states
        caption.style.opacity = 0;
        heart.style.opacity = 0; heart.style.transform = 'translate(0,0)';
        cat.style.opacity = 1; rainbow.style.opacity = 1;

        const W = stage.clientWidth, H = stage.clientHeight;
        const catW = 6*12; // from CSS sprite: 6x scale * ~12px width
        const catH = 6*10;

        // start position
        let x = -catW - 40; 
        const y = H*0.55 - catH/2;
        const targetX = W*0.60;

        cat.style.left = x + 'px';
        cat.style.top = y + 'px';

        // rainbow sizing: keep it aligned to cat centerY
        function layoutRainbow(){
          const yMid = y + catH/2 - 19; // center minus half rainbow height
          rainbow.style.top = yMid + 'px';
          rainbow.style.width = Math.max(60, x + catW*0.8) + 'px';
        }

        const t0 = performance.now();
        const dur = 1800; // ms

        function easeOutQuart(t){ return 1 - Math.pow(1 - t, 4); }

        function frame(now){
          const p = Math.min(1, (now - t0)/dur);
          const e = easeOutQuart(p);
          x = (-catW - 40) + (targetX - (-catW - 40))*e;
          cat.style.left = x + 'px';
          layoutRainbow();
          if(p < 1){ requestAnimationFrame(frame); }
          else kiss();
        }
        requestAnimationFrame(frame);

        function kiss(){
          // tiny pop (scale)
          cat.animate([
            { transform: 'scale(1)' },
            { transform: 'scale(1.08)' },
            { transform: 'scale(1)' }
          ], { duration: 240, easing:'ease-out' });

          // heart: float up + fade
          const hx = x + catW - 10;
          const hy = y + catH/2 + 6;
          heart.style.left = hx + 'px';
          heart.style.top = hy + 'px';
          heart.style.opacity = 1;
          heart.animate([
            { transform:'translate(0,0)', opacity:1 },
            { transform:'translate(0,-40px)', opacity:0 }
          ], { duration: 800, easing:'ease-out' }).onfinish = ()=>{
            heart.style.opacity = 0;
          };

          // caption: fade in
          caption.animate([
            { opacity: 0 },
            { opacity: 1 }
          ], { duration: 1200, easing:'ease-out' }).onfinish = ()=>{
            caption.style.opacity = 1;
          };
        }
      }

      // Autostart once photo has a source
      photo.addEventListener('load', ()=> start(), { once:true });

      // Tap anywhere to replay
      stage.addEventListener('click', ()=> start());

      // Handle resize
      window.addEventListener('resize', ()=> start());
    })();
  </script>
</body>
</html>
